<?php

namespace HW3\NewsBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * NewsRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class NewsRepository extends EntityRepository
{
    function getNewsFromGroup($group, $from, $limit)
    {
        return $this->findBy(array(
            'newsgroup' => $group->getId(),
            'confirmed' => 1
        ), array(
            'creation_date' => 'DESC',
        ), $limit, $from);
    }

    function getNewsCount($group)
    {
        return count($this->findBy(array(
            'newsgroup' => $group
        )));
    }

    function getHotNews($limit)
    {
        $db = $this->createQueryBuilder('n')
            ->where('n.creation_date > :date')
            ->setParameter('date', new \DateTime('yesterday'))
            ->andWhere('n.confirmed = true')
            ->addOrderBy('n.visit', 'DESC')
            ->addOrderBy('n.creation_date', 'DESC')
            ->setMaxResults($limit);
        $result = $db->getQuery()->getResult();

        if (count($result) < $limit / 2) {
            $db = $this->createQueryBuilder('n')
                ->where('n.confirmed = true')
                ->addOrderBy('n.visit', 'DESC')
                ->addOrderBy('n.creation_date', 'DESC')
                ->setMaxResults($limit);
            $result = $db->getQuery()->getResult();
        }
        return $result;
    }

    function getRecentNews($limit)
    {
        $db = $this->createQueryBuilder('n')
            ->where('n.confirmed = true')
            ->addOrderBy('n.creation_date', 'DESC')
            ->setMaxResults($limit);
        return $db->getQuery()->getResult();
    }

    function getRelatedNews($news, $limit)
    {
        $tags = $news->getTags();
        $result = [];
        foreach ($tags as $tag) {
            $news = $tag->getNews();
            foreach ($news as $new)
                if ($new->getConfirmed())
                    $result[] = $new;
        }
        return $result;
    }

    function search($query, $fields, $from, $to, $newsgroups, $limit, $offset)
    {
        $query = '%' . $query . '%';

        $db = $this->createQueryBuilder('n')
            ->where('n.confirmed = true');

        if ($from != null)
            $db = $db->andWhere('n.creation_date >= :from_date')
                ->setParameter('from_date', $from);

        if ($to != null)
            $db = $db->andWhere('n.creation_date <= :to_date')
                ->setParameter('to_date', $to);

        $str_cont = '';
        foreach ($newsgroups as $group) {
            if (strlen($str_cont) > 0)
                $str_cont = $str_cont . ' OR ';
            $str_cont = $str_cont . 'n.newsgroup = ' . $group->getID();
        }
        if (strlen($str_cont) > 0)
            $db = $db->andWhere($str_cont);


        $str_cont = '';
        foreach ($fields as $field) {
            if (strlen($str_cont) > 0)
                $str_cont = $str_cont . ' OR ';
            $str_cont = $str_cont . 'n.' . $field . ' LIKE :' . $field;
        }
        if (strlen($str_cont) > 0)
            $db = $db->andWhere($str_cont);
        foreach ($fields as $field)
            $db = $db->setParameter($field, $query);

        $db = $db->addOrderBy('n . creation_date', 'DESC')
            ->setMaxResults($limit)
            ->setFirstResult($offset);

        return $db->getQuery()->getResult();
    }

    function getSelectedNews($limit)
    {
        $db = $this->createQueryBuilder('n')
            ->where('n . selected = true')
            ->where('n . confirmed = true')
            ->addOrderBy('n . creation_date', 'DESC')
            ->setMaxResults($limit);
        $result = $db->getQuery()->getResult();
        return $result;
    }

    function getConfirmedNews($limit)
    {
        $db = $this->createQueryBuilder('n')
            ->where('n . confirmed = true')
            ->addOrderBy('n . creation_date', 'DESC')
            ->setMaxResults($limit);
        $result = $db->getQuery()->getResult();
        return $result;
    }

    function getUnconfirmedNews()
    {
        $db = $this->createQueryBuilder('n')
            ->where('n . confirmed = false')
            ->addOrderBy('n . creation_date', 'DESC');
        $result = $db->getQuery()->getResult();
        return $result;
    }
}